<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- external data with jsonp -->
    <script>
        var signMapping;
        function liikennemerkitCallback (json) {
            signMapping = json;
        }

    </script>
    <script src="https://cdn.rawgit.com/jikuja/liikennemerkkinumerot/master/merkit_map.js"></script>

    <!-- leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.1.0/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.1.0/dist/MarkerCluster.Default.css">

    <!-- leaflet plugins -->
    <script src="https://unpkg.com/leaflet.markercluster@1.1.0/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-ajax@2.1.0/dist/leaflet.ajax.min.js"></script>
    <script src="https://use.fontawesome.com/1cd05babcb.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.awesome-markers@2.0.4/dist/leaflet.awesome-markers.css"/>
    <script src="https://unpkg.com/leaflet.awesome-markers@2.0.4/dist/leaflet.awesome-markers.min.js"></script>
    <title>Title</title>
</head>

<body>
    <a href="https://github.com/jikuja/leaflet-liikennemerkit"><img style="position: absolute; top: 0; right: 0; border: 0;z-index: 9999;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>
    <div id="mapid" style="height: 600px;"></div>

    <script>
        var signAttribution =
            'Sign data &copy; <a href="http://www.lounaistieto.fi/blog/2016/03/30/turun-kaupungin-liikennemerkit/">Turun kaupunki</a>, ' +
            '<a href="https://creativecommons.org/licences/by/4.0/deed.fi">CC-BY</a>';

        // TODO: fix ... when opening patricular marker with ID
        var mymap = L.map('mapid').setView([60.440963, 22.25122], 10);
        var popup = L.popup();
        var magicNumber = 54;

        var radius = function(zoom) { // spiderify/cluster only overlapping mark when zoom >= 18
            if (zoom >= 18)
                return 5;
            return 80;
        };

        mymap.on("zoomend", function (e) {
            console.log("Zoom level: %s", e.target._zoom);
        });

        // create map
        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution:
                'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
            id: 'mapbox.streets'
        }).addTo(mymap);

        // add cluster layer
        var clusterGroup = L.markerClusterGroup({
            // attribution in geojsonLayer is ignored
            attribution: signAttribution,
            //disableClusteringAtZoom : 18,
            maxClusterRadius: radius,
            spiderfyOnMaxZoom: true
        });
        mymap.addLayer(clusterGroup);

        // load geojson data into
        var geojsonLayer = new L.GeoJSON.AJAX("liikennemerkit.json");
        geojsonLayer.on("click", onMarkerClick);
        geojsonLayer.on("data:loaded", function () {
            // add geojson layer into cluster layer after data is loaded
            clusterGroup.addLayer(geojsonLayer);
            // after data is loaded we can zoom in to particular sign if given as argument
            scrollToSign();
        });

        function fix(s) {
            var ret = s.match(/(\d+)([a-zöäå]+)/);
            if (ret) {
                var value = ret[1] + " " + ret[2];
                console.log("Fixed %s to %s", s, value)
                return value;
            }
            return s;
        }
        var argMarker;

        function scrollToSign() {
            var searchParams = new URL(window.location.href).searchParams;
            // current data does not contain unique ID
            // use geojsonLayer._layers keys as workaround
            if (searchParams && searchParams.has("aid")) {
                var num = parseInt(searchParams.get("aid"));
                if (isNaN(num)) {
                    console.log("Failed to parse input: %s", searchParams.get("aid"));
                    return;
                }
                console.log("zooming to %sth marker", num);
                argMarker = geojsonLayer._layers[magicNumber + num];
                console.log("marker: ", argMarker);
                clusterGroup.zoomToShowLayer(argMarker, function () {
                    popupHelper(argMarker.feature.properties, argMarker.getLatLng());
                });
                argMarker.setIcon(L.AwesomeMarkers.icon({icon: 'exclamation-circle', markerColor: 'blue', prefix: 'fa'}));
            }
        }

        function popupHelper(prop, latlong) {
            console.log(prop);
            var text = signMapping[fix(prop["signtype"])];
            if (!text)
                text = "Tunnistamaton";
            popup.setLatLng(latlong)
                .setContent(text)
                .openOn(mymap);
        }

        function onMarkerClick(e) {
            var prop = e.layer.feature.properties;
            popupHelper(prop, e.latlng);
        }

    </script>
</body>

</html>